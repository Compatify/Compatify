<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Optimized Title Tag for SEO -->
    <title>Compatify: Device Compatibility Checker & Upgrade Roadmaps | Future-Proof Your Tech</title>
    <!-- Favicon (Browser Tab Logo) -->
    <link rel="icon" href="Compatify-logo.PNG" type="image/png">
    <!-- Meta Description for SEO -->
    <meta name="description" content="Use Compatify to quickly check compatibility between any two devices, generate personalized upgrade roadmaps, and understand obsolescence risks for your tech.">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google AdSense Auto Ads Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2091022065516798"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Lighter background for the entire page */
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        .section {
            display: none; /* Hide all sections by default */
        }
        .section.active {
            display: block; /* Show the active section */
        }
        .nav-link.active {
            font-weight: 700;
            color: #1f2937;
            border-bottom: 2px solid #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 md:flex md:justify-between md:items-center">
            <a href="#" class="text-xl font-bold text-gray-800 md:text-2xl hover:text-gray-700">Compatify</a>
            <div class="flex-1 flex justify-center mt-4 md:mt-0">
                <div class="flex space-x-4">
                    <a href="#home" class="nav-link text-gray-600 hover:text-gray-800 transition-colors duration-200 p-2">Home</a>
                    <a href="#checker" class="nav-link text-gray-600 hover:text-gray-800 transition-colors duration-200 p-2">Checker</a>
                    <a href="#roadmap" class="nav-link text-gray-600 hover:text-gray-800 transition-colors duration-200 p-2">Roadmap</a>
                    <a href="#about" class="nav-link text-gray-600 hover:text-gray-800 transition-colors duration-200 p-2">About</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-6">
        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to Compatify</h1>
                <p class="text-gray-600 mb-6">Your ultimate tool for checking device compatibility and planning your tech upgrades. Use the sections above to get started.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="p-6 rounded-lg shadow-sm bg-blue-50">
                        <h3 class="text-xl font-semibold mb-2 text-blue-800">Compatibility Checker</h3>
                        <p class="text-gray-700">Quickly see if two devices work together.</p>
                    </div>
                    <div class="p-6 rounded-lg shadow-sm bg-green-50">
                        <h3 class="text-xl font-semibold mb-2 text-green-800">Upgrade Roadmap</h3>
                        <p class="text-gray-700">Plan your tech future with a personalized roadmap.</p>
                    </div>
                    <div class="p-6 rounded-lg shadow-sm bg-purple-50">
                        <h3 class="text-xl font-semibold mb-2 text-purple-800">Obsolescence Risk</h3>
                        <p class="text-gray-700">Understand the risks of your current tech setup.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compatibility Checker Section -->
        <section id="checker" class="section">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Compatibility Checker</h2>
                
                <form id="checker-form" class="space-y-6">
                    <div>
                        <label for="device1-input" class="block text-sm font-medium text-gray-700">Describe Device 1:</label>
                        <textarea id="device1-input" name="device1-input" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="e.g., 'MacBook Pro 2021 with M1 Pro chip, 2x USB-C ports with Thunderbolt 4, 1x HDMI 2.0'"></textarea>
                    </div>
                    
                    <div>
                        <label for="device2-input" class="block text-sm font-medium text-gray-700">Describe Device 2:</label>
                        <textarea id="device2-input" name="device2-input" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="e.g., '4K Monitor with HDMI 2.1, DisplayPort 1.4, USB-C Power Delivery 65W'"></textarea>
                    </div>

                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Run Compatibility Check
                    </button>
                </form>

                <div id="results-container" class="mt-8 p-4 bg-gray-50 rounded-lg shadow-inner text-center">
                    <div id="loading-indicator" class="hidden flex items-center justify-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-blue-600 font-medium">Checking compatibility...</span>
                    </div>
                    <p id="placeholder-text" class="text-gray-500">Compatibility results will appear here after you run a check.</p>
                </div>
                
                <!-- Recommended Products Section -->
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Recommended Products</h3>
                    <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full">Run a compatibility check to see recommendations...</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Roadmap Section -->
        <section id="roadmap" class="section">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Upgrade Roadmap</h2>
                <div id="roadmap-steps-container" class="space-y-6">
                    <div class="p-6 rounded-lg bg-gray-50 shadow-inner">
                        <p class="text-gray-500 text-center">Your personalized roadmap will appear here.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="section">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">About Compatify</h2>
                <p class="text-gray-600">Compatify is a tool designed to help you make informed decisions about your tech purchases by checking compatibility and providing future-proof upgrade paths.</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-auto py-6">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Compatify. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modal for messages -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-[9999]">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modal-title" class="text-lg font-bold">Message</h4>
                <button id="modal-close-button" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p id="modal-message" class="text-gray-600"></p>
        </div>
    </div>

    <script>
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const modal = document.getElementById('message-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        // Global variable to hold the product data once it's fetched
        let productData = [];

        // --- Mock Data for Roadmap (for demonstration) ---
        const mockRoadmapData = [
            {
                title: "Step 1: Assess Your Current Setup",
                description: "Identify all primary devices and their key specifications.",
                status: "completed",
            },
            {
                title: "Step 2: Check Key Compatibilities",
                description: "Use the Compatibility Checker to verify core device interoperability.",
                status: "in-progress",
            },
            {
                title: "Step 3: Research Potential Upgrades",
                description: "Explore future-proof products that match your needs and existing tech.",
                status: "pending",
                products: ["Product A", "Product B", "Product C"]
            },
            {
                title: "Step 4: Create an Upgrade Budget",
                description: "Allocate funds for new purchases and plan your spending.",
                status: "pending"
            }
        ];

        // --- Helper function to show a message modal ---
        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideMessage() {
            modal.classList.add('hidden');
        }

        // --- UI Rendering Functions ---
        function renderSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
            }
            navLinks.forEach(link => {
                if (link.getAttribute('href').substring(1) === sectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        function renderRoadmap(data) {
            const roadmapStepsContainer = document.getElementById('roadmap-steps-container');
            roadmapStepsContainer.innerHTML = ''; // Clear previous content

            data.forEach((step, index) => {
                const statusColor = {
                    "completed": "bg-green-100 border-green-500",
                    "in-progress": "bg-blue-100 border-blue-500",
                    "pending": "bg-gray-100 border-gray-300"
                }[step.status];

                const statusIcon = {
                    "completed": `<svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`,
                    "in-progress": `<svg class="w-6 h-6 text-blue-600 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg>`,
                    "pending": `<svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`
                }[step.status];

                const stepCard = document.createElement('div');
                stepCard.className = `p-6 rounded-lg border-l-4 shadow-sm ${statusColor}`;
                stepCard.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">${statusIcon}</div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${step.title}</h4>
                            <p class="text-gray-700">${step.description}</p>
                        </div>
                    </div>
                    ${step.products && step.products.length > 0 ? `<p class="mt-4 text-gray-700"><strong>Mock Recommended Products:</strong> ${step.products.join(', ')}</p>` : ''}
                `;
                roadmapStepsContainer.appendChild(stepCard);
            });
        }

        // --- Core Logic for Compatibility Checker (UPDATED) ---

        // The API key is provided by the canvas environment.
        const apiKey = ""; 

        // Function to call the LLM and get a list of compatibility tags
        async function getTagsFromLLM(description) {
            const prompt = `Given the following device description, identify a list of technical specifications and compatibility keywords. Respond with a JSON array of strings. For example, for 'Hiearcool USB C Hub', the response could be ['USB-C', 'HDMI', '4K', 'USB 3.0', '100W Power Delivery']. Device description: ${description}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            // Implement exponential backoff for API calls
            const maxRetries = 5;
            let retryCount = 0;
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedJson = JSON.parse(jsonString);
                        // Ensure the result is an array of strings
                        if (Array.isArray(parsedJson) && parsedJson.every(item => typeof item === 'string')) {
                            return parsedJson;
                        } else {
                            throw new Error('Unexpected JSON format from API.');
                        }
                    } else {
                        throw new Error('No content found in API response.');
                    }
                } catch (error) {
                    console.error(`Attempt ${retryCount + 1} failed: ${error.message}`);
                    if (retryCount < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                        retryCount++;
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('Failed to get tags from LLM after multiple retries.');
        }

        // Function to check compatibility based on tags
        function checkCompatibility(device1Tags, device2Tags) {
            // Ensure inputs are arrays
            if (!Array.isArray(device1Tags) || !Array.isArray(device2Tags)) {
                console.error('Inputs to checkCompatibility must be arrays.');
                return { status: 'error', message: 'Invalid input data.' };
            }
            
            // Convert all tags to lowercase for case-insensitive comparison
            const lowerDevice1Tags = device1Tags.map(tag => tag.toLowerCase());
            const lowerDevice2Tags = device2Tags.map(tag => tag.toLowerCase());
            
            // Find common tags
            const sharedTags = lowerDevice1Tags.filter(tag => lowerDevice2Tags.includes(tag));
            
            if (sharedTags.length > 0) {
                return {
                    status: 'compatible',
                    message: `The devices are compatible! They share the following tags: ${sharedTags.join(', ')}.`,
                    sharedTags: sharedTags
                };
            } else {
                return {
                    status: 'incompatible',
                    message: 'The devices appear to be incompatible. No common compatibility tags were found.',
                    sharedTags: []
                };
            }
        }

        // Function to recommend products based on shared tags
        function recommendProducts(sharedTags) {
            if (sharedTags.length === 0) {
                return [];
            }

            const lowerSharedTags = sharedTags.map(tag => tag.toLowerCase());
            
            // Find products that contain at least one of the shared tags
            const recommended = productData.filter(product => {
                // Ensure product.compatibility_tags is an array
                if (!Array.isArray(product.compatibility_tags)) {
                    return false;
                }
                const lowerProductTags = product.compatibility_tags.map(tag => tag.toLowerCase());
                return lowerSharedTags.some(tag => lowerProductTags.includes(tag));
            });

            return recommended;
        }

        // Function to render the compatibility results to the UI
        function renderCompatibilityResults(result) {
            const resultsContainer = document.getElementById('results-container');
            const productsContainer = document.getElementById('products-container');
            const placeholderText = document.getElementById('placeholder-text');

            // Clear previous results and placeholder
            resultsContainer.innerHTML = '';
            productsContainer.innerHTML = '';
            placeholderText.classList.add('hidden');
            
            // Show the container
            resultsContainer.classList.remove('hidden');
            
            // Build the new content for compatibility result
            let content = '';
            if (result.status === 'compatible') {
                content = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-4" role="alert">
                        <p class="font-bold">Compatible!</p>
                        <p>${result.message}</p>
                    </div>
                `;
            } else if (result.status === 'incompatible') {
                content = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4" role="alert">
                        <p class="font-bold">Incompatible!</p>
                        <p>${result.message}</p>
                    </div>
                `;
            } else {
                 content = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-4" role="alert">
                        <p class="font-bold">Warning!</p>
                        <p>${result.message}</p>
                    </div>
                `;
            }
            resultsContainer.innerHTML = content;

            // Render recommended products
            if (result.recommendedProducts && result.recommendedProducts.length > 0) {
                result.recommendedProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-gray-100 rounded-lg p-4 shadow-sm flex flex-col items-center text-center';
                    productCard.innerHTML = `
                        <img src="${product.image_url}" alt="${product.name}" class="w-24 h-24 object-cover rounded-md mb-4">
                        <h4 class="font-semibold text-lg mb-2">${product.name}</h4>
                        <p class="text-sm text-gray-600 mb-4">${product.description.substring(0, 100)}...</p>
                        <a href="${product.affiliate_link}" target="_blank" class="mt-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">View Product</a>
                    `;
                    productsContainer.appendChild(productCard);
                });
            } else {
                productsContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">No specific product recommendations found.</p>';
            }
        }

        // --- Event Listeners ---\n
        const checkerForm = document.getElementById('checker-form');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Async function to handle the full compatibility check
        async function runCompatibilityCheck() {
            const device1Input = document.getElementById('device1-input').value;
            const device2Input = document.getElementById('device2-input').value;

            // Simple check for empty inputs
            if (!device1Input || !device2Input) {
                showMessage('Warning', 'Please enter descriptions for both devices.');
                return;
            }

            // Show loading indicator and hide previous content
            loadingIndicator.classList.remove('hidden');
            document.getElementById('placeholder-text').classList.add('hidden');
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('products-container').innerHTML = '';

            try {
                // Concurrently get compatibility tags for both devices
                const [tags1, tags2] = await Promise.all([
                    getTagsFromLLM(device1Input),
                    getTagsFromLLM(device2Input)
                ]);

                // Run the compatibility check
                const result = checkCompatibility(tags1, tags2);

                // Recommend products based on shared tags
                if (result.status === 'compatible') {
                    result.recommendedProducts = recommendProducts(result.sharedTags);
                }

                // Render the results to the UI
                renderCompatibilityResults(result);

            } catch (error) {
                console.error('Error during compatibility check:', error);
                showMessage('Error', `An error occurred while checking compatibility: ${error.message}`);
                // Re-show placeholder text on error
                document.getElementById('placeholder-text').classList.remove('hidden');
            } finally {
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // First, fetch the product data
            try {
                const response = await fetch('./affiliate_products.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                productData = await response.json();
            } catch (error) {
                console.error('Failed to load product data:', error);
                showMessage('Error', 'Could not load product data. The recommendation feature may not work correctly.');
            }

            // Check if a specific section is indicated in the URL hash on initial load
            const initialHash = window.location.hash;
            if (initialHash) {
                const sectionId = initialHash.split('?')[0].substring(1);
                renderSection(sectionId);
                // Also render the roadmap if the user lands on that section
                if (sectionId === 'roadmap') {
                    renderRoadmap(mockRoadmapData);
                }
            } else {
                renderSection('home'); // Render homepage on load
            }

            // Navigation links
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default anchor behavior
                    const sectionId = link.getAttribute('href').split('?')[0].substring(1); // Get section ID from href, strip query params
                    // Update URL hash without reloading the page
                    window.history.pushState(null, '', link.getAttribute('href'));
                    renderSection(sectionId);
                    // If navigating to the roadmap, render the mock data
                    if (sectionId === 'roadmap') {
                        renderRoadmap(mockRoadmapData);
                    }
                });
            });

            // Compatibility checker form submission listener
            checkerForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent page reload
                await runCompatibilityCheck();
            });

            // Modal close button
            modalCloseButton.addEventListener('click', hideMessage);
        });
    </script>
</body>
</html>
